name: CI/CD

on:
  push:
    branches: [main, alpha]
    tags: ['v*']
  pull_request:
    branches: [main, alpha]

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Test
        run: dotnet test --no-build -c Release --logger trx --results-directory TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/*/bin/Release/
            src/*/obj/Release/
          retention-days: 1

  aot-test:
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
          - os: macos-latest
            rid: osx-arm64
          - os: windows-latest
            rid: win-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Publish AOT binary
        run: dotnet publish tests/TONL.NET.AotTests -c Release -r ${{ matrix.rid }}

      - name: Run AOT binary (Unix)
        if: runner.os != 'Windows'
        run: ./tests/TONL.NET.AotTests/bin/Release/net9.0/${{ matrix.rid }}/publish/TONL.NET.AotTests

      - name: Run AOT binary (Windows)
        if: runner.os == 'Windows'
        run: ./tests/TONL.NET.AotTests/bin/Release/net9.0/${{ matrix.rid }}/publish/TONL.NET.AotTests.exe

  publish:
    needs: [build, aot-test]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $TAG"

      - name: Build
        run: dotnet build -c Release

      - name: Pack
        run: dotnet pack src/TONL.NET.Core/TONL.NET.Core.csproj -c Release -p:Version=${{ steps.version.outputs.VERSION }} -o ./nupkg --no-build

      - name: Generate attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ./nupkg/*.nupkg

      - name: Push to GitHub Packages
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/iamadamreed/index.json --skip-duplicate

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: ./nupkg/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
